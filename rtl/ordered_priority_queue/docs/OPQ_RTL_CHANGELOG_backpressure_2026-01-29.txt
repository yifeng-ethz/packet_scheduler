OPQ RTL Change Log â€” Backpressure handling
Date: 2026-01-29

Context
-------
System-level simulation (FEB 125 MHz -> OPQ 250 MHz) with intermittent deassertion of `aso_egress_ready`
showed duplicated hits and framing/context errors (hits outside subheader context). The root cause is that
the FTABLE_PRESENTER reads from a synchronous (registered-output) page RAM pipeline (EGRESS_DELAY=3),
so a simple "hold output_data + stop rptr" is not sufficient: in-flight words can be overwritten and/or
replayed incorrectly when backpressure occurs mid-packet.

Changes
-------
Files touched:
- packet_scheduler/ordered_priority_queue.terp.vhd
- packet_scheduler/tb/ordered_priority_queue/update_preprocessed.sh

1) FTABLE_PRESENTER stall -> RESTART (rollback + refill)
   - When a valid word is at the egress tap and `aso_egress_ready` deasserts, transition to `RESTART`.
   - Roll back the active tile `page_ram_rptr` by `(EGRESS_DELAY + 1)` so the next refill starts at the
     stalled output word address.
   - Clear `output_data_valid` to restart the pipeline.

2) RESTART state rewritten (deterministic refill)
   - Refill the page RAM pipeline starting from the rolled-back address:
     - shift `output_data_valid` forward each cycle
     - advance `page_ram_rptr` only while `output_data_valid(EGRESS_DELAY) = 0`
     - update `output_data <= page_ram_rd_data` during refill
   - Transition back to `PRESENTING` when the last shift will make the egress tap valid
     (`output_data_valid(EGRESS_DELAY-1) = 1`).

3) Gate external `aso_egress_valid` by presenter state
   - `aso_egress_valid` is asserted only in `PRESENTING`.
   - This prevents any word in `RESTART` from being accepted and then re-accepted after returning to
     `PRESENTING` (double-accept bug).

Notes
-----
Simulation uses the preprocessed OPQ RTL generated by:
`packet_scheduler/tb/ordered_priority_queue/update_preprocessed.sh`
The patcher mirrors the above logic into the generated `ordered_priority_queue.vhd` so system-level
simulation and the `.terp.vhd` template stay aligned.

